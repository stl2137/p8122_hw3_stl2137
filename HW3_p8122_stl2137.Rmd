---
title: "P8122 HW3"
author: "Sabrina Lin stl2137"
date: "11/21/2020"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
library(tableone)
library(mlogit)
library(personalized)
```

# Part 1

```{r}
### read in data
salary_dat <- read_csv("/Users/SabrinaLin/Documents/Fall_2020_Causal_Inference/Homework/HW3/p8122_hw3_stl2137/hW3\ data.csv") %>% 
  mutate(
    treat = as.factor(treat),
    black = as.factor(black),
    hispan = as.factor(hispan),
    married = as.factor(married),
    nodegree = as.factor(nodegree)
  )

salary_dat <- as.data.frame(salary_dat)
```


* data consists of 10 variables measured for each individual:

  * an indicator of treatment assignment (job training), `treat` 
  
  * age in years, `age`
  
  * education in years, `educ`
  
  * an indicator for African-American, `black` 
  
  * an indicator for Hispanic, `hispan`
  
  * an indicator for married, `married`
  
  * an indicator for high school degree, `nodegree`
  
  * income in 1974, `re74` 
  
  * income in 1975 `re75` 
  
  * income in 1978, `re78`

* The variable `treat` is the treatment and the variables `re78` is the outcome.

## Subpart 1
Write the DAG representing this observational study including all variables provided. Describe all the variables in the graph.


## Subpart 2
Evaluate covariate balance in this observational study. Show a table or a plot. Interpret the results.

```{r}
## Construct a table
vars <- c("age", "educ", "black", "hispan", "married", "nodegree", "re74", "re75", "re78")

tab_presub <- CreateTableOne(vars = vars, strata = "treat", data = salary_dat, test = FALSE)

print(tab_presub, smd = TRUE)
```

* Given that we would like the SMD to be less than 0.2 and having seen 0.25 as a common guideline for SMD in the literature, there are several variables that surpass this rule of thumb. The SMD (standardized mean difference) for the variable `black` is very large at 1.671, indicating that the covariate balance for this variable is not good. The variables `married` and `re74` also have relatively large SMDs (0.721 and 0.596 respectively), also indicating that the covariate balance for these variables is not great. 

## Subpart 3
The propensity score is defined as the probability of receiving the treatment given the observed covariates. These scores are used to construct strata within which we assume that the exposure assignment is random. Construct propensity scores by fitting a logistic regression to the data.

```{r}
salary_mlogit_dat <- mlogit.data(salary_dat, choice = "treat", shape = "wide")
fit_sal <- mlogit(treat ~ 0 | age + educ + black + hispan + married + nodegree + re74 + re75, data = salary_mlogit_dat)
summary(fit_sal)

ps_model <- glm(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75, data = salary_dat, family = binomial)
summary(ps_model)

salary_dat$ps <- predict(ps_model, type = "response")

```

# Subpart 4
Given the propensity scores estimated, evaluate overlap. Trim data if necessary and evaluate the impact of trimming in your analytic sample on efficiency and generalizability.

```{r}
### visualization of overlap 

prop_func <- function(x, trt)
{
    # fit propensity score model
  propens.model <- glm(treat ~ age + educ + black + hispan + married + nodegree + re74 + re75, data = salary_dat, family = binomial)
  pi.x <- predict(propens.model, type = "response")
  pi.x
}

check.overlap(x = salary_dat,
              trt = salary_dat$treat,
              propensity.func = prop_func)

### now add density plot with histogram

check.overlap(x = salary_dat,
              trt = salary_dat$treat,
              type = "both",
              propensity.func = prop_func)
```

```{r}
ps <- salary_dat$ps

#eliminate non comparable cases and generate the analytic data

### eliminate controls where the P(A=1|C) is less than the min(P(A=1|C)) found in the treated group
min(ps[salary_dat$treat==1])
ps[which(salary_dat$treat==0)] <=min(ps[salary_dat$treat==1])
length(ps[which(salary_dat$treat==0)]<= min(ps[salary_dat$treat==1]))

#eliminate treated where the P(A=1|C) is greater that the max(P(A=1|C)) found in the control group
max(ps[salary_dat$treat==0])
ps[which(salary_dat$treat==1)]>= max(ps[salary_dat$treat==0])

length(ps[which(salary_dat$treat==0)]<= min(ps[salary_dat$treat==0]))

data = salary_dat[ps>=min(ps[salary_dat$treat==1]) & ps <= max(ps[salary_dat$treat==0]),]
dim(salary_dat)
dim(data)
```

